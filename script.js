const V2SA_DEMOS = [
  {
    id: "demo01",
    video360: "./assets/v2sa/1whJPpizoDA_86/1whJPpizoDA_86.mp4",
    foa: {
      gt: "./assets/v2sa/1whJPpizoDA_86/1whJPpizoDA_86_gt.wav",
      visage: "./assets/v2sa/1whJPpizoDA_86/1whJPpizoDA_visage.wav",
      omniaudio: "./assets/v2sa/1whJPpizoDA_86/1whJPpizoDA_86_omni.wav",
      s3audio: "./assets/v2sa/1whJPpizoDA_86/1whJPpizoDA_86.wav",
    }
  },
  {
    id: "demo02",
    video360: "./assets/v2sa/1WFJLucjK50_529/1WFJLucjK50_529.mp4",
    foa: {
      gt: "./assets/v2sa/1WFJLucjK50_529/1WFJLucjK50_529_gt.wav",
      visage: "./assets/v2sa/1WFJLucjK50_529/1WFJLucjK50_visage.wav",
      omniaudio: "./assets/v2sa/1WFJLucjK50_529/1WFJLucjK50_529_omni.wav",
      s3audio: "./assets/v2sa/1WFJLucjK50_529/1WFJLucjK50_529.wav",
    }
  },
  {
    id: "demo03",
    video360: "./assets/v2sa/9X2wM6HD_og_933/9X2wM6HD_og_933.mp4",
    foa: {
      gt: "./assets/v2sa/9X2wM6HD_og_933/9X2wM6HD_og_933_gt.wav",
      visage: "./assets/v2sa/9X2wM6HD_og_933/9X2wM6HD_og_visage.wav",
      omniaudio: "./assets/v2sa/9X2wM6HD_og_933/9X2wM6HD_og_933_omni.wav",
      s3audio: "./assets/v2sa/9X2wM6HD_og_933/9X2wM6HD_og_933.wav",
    }
  },
  {
    id: "demo04",
    video360: "./assets/v2sa/fQukntBmFvY_40/fQukntBmFvY_40.mp4",
    foa: {
      gt: "./assets/v2sa/fQukntBmFvY_40/fQukntBmFvY_40_gt.wav",
      visage: "./assets/v2sa/fQukntBmFvY_40/fQukntBmFvY_visage.wav",
      omniaudio: "./assets/v2sa/fQukntBmFvY_40/fQukntBmFvY_40_omni.wav",
      s3audio: "./assets/v2sa/fQukntBmFvY_40/fQukntBmFvY_40.wav",
    }
  },
  {
    id: "demo05",
    video360: "./assets/v2sa/OWN_J9FGZ5I_55/OWN_J9FGZ5I_55.mp4",
    foa: {
      gt: "./assets/v2sa/OWN_J9FGZ5I_55/OWN_J9FGZ5I_55_gt.wav",
      visage: "./assets/v2sa/OWN_J9FGZ5I_55/OWN_J9FGZ5I_visage.wav",
      omniaudio: "./assets/v2sa/OWN_J9FGZ5I_55/OWN_J9FGZ5I_55_omni.wav",
      s3audio: "./assets/v2sa/OWN_J9FGZ5I_55/OWN_J9FGZ5I_55.wav",
    }
  },
  {
    id: "demo06",
    video360: "./assets/v2sa/kMZSoni0etA_10/kMZSoni0etA_10.mp4",
    foa: {
      gt: "./assets/v2sa/kMZSoni0etA_10/kMZSoni0etA_10_gt.wav",
      visage: "./assets/v2sa/kMZSoni0etA_10/kMZSoni0etA_visage.wav",
      omniaudio: "./assets/v2sa/kMZSoni0etA_10/kMZSoni0etA_10_omni.wav",
      s3audio: "./assets/v2sa/kMZSoni0etA_10/kMZSoni0etA_10.wav",
    }
  },
];

/* ====== T2SA (NEW) ======
   File paths are placeholders. You will fill them similarly to V2SA_DEMOS.
*/
const T2SA_DEMOS = [
  {
    id: "",
    text: "An ensemble concert, with music coming from all around.",
    foa: {
      gt: "./assets/t2sa/_yNwzbv3PeI_16/_yNwzbv3PeI_16_gt.wav",
      mmaudio_as: "./assets/t2sa/_yNwzbv3PeI_16/_yNwzbv3PeI_16_mm.wav",
      omniaudio_text: "./assets/t2sa/_yNwzbv3PeI_16/_yNwzbv3PeI_16_omni.wav",
      s3audio: "./assets/t2sa/_yNwzbv3PeI_16/_yNwzbv3PeI_16.wav",
    }
  },
  {
    id: "",
    text: "A marching band is initially heard in front and then shifts to the right side.",
    foa: {
      gt: "./assets/t2sa/aieThfuvmtY_16/aieThfuvmtY_16_gt.wav",
      mmaudio_as: "./assets/t2sa/aieThfuvmtY_16/aieThfuvmtY_16_mm.wav",
      omniaudio_text: "./assets/t2sa/aieThfuvmtY_16/aieThfuvmtY_16_omni.wav",
      s3audio: "./assets/t2sa/aieThfuvmtY_16/aieThfuvmtY_16.wav",
    }
  },
  {
    id: "",
    text: "The thundering roar of a waterfall comes continuously from the left, accompanied by the crashing sound of turbulent water.",
    foa: {
      gt: "./assets/t2sa/0B7ds6NmVBQ_30/0B7ds6NmVBQ_30_gt.wav",
      mmaudio_as: "./assets/t2sa/0B7ds6NmVBQ_30/0B7ds6NmVBQ_30_mm.wav",
      omniaudio_text: "./assets/t2sa/0B7ds6NmVBQ_30/0B7ds6NmVBQ_30_omni.wav",
      s3audio: "./assets/t2sa/0B7ds6NmVBQ_30/0B7ds6NmVBQ_30.wav",
    }
  },
  {
    id: "",
    text: "The sound of a solo guitar playing comes from the front.",
    foa: {
      gt: "./assets/t2sa/0FB9jMXMP8A_0/0FB9jMXMP8A_0_gt.wav",
      mmaudio_as: "./assets/t2sa/0FB9jMXMP8A_0/0FB9jMXMP8A_0_mm.wav",
      omniaudio_text: "./assets/t2sa/0FB9jMXMP8A_0/0FB9jMXMP8A_0_omni.wav",
      s3audio: "./assets/t2sa/0FB9jMXMP8A_0/0FB9jMXMP8A_0.wav",
    }
  },
  {
    id: "",
    text: "The distant roar of a train, accompanied by the rhythmic clacking of tracks, gradually approaches from the left to right.",
    foa: {
      gt: "./assets/t2sa/G8pABGosD38_17/G8pABGosD38_17_gt.wav",
      mmaudio_as: "./assets/t2sa/G8pABGosD38_17/G8pABGosD38_17_mm.wav",
      omniaudio_text: "./assets/t2sa/G8pABGosD38_17/G8pABGosD38_17_omni.wav",
      s3audio: "./assets/t2sa/G8pABGosD38_17/G8pABGosD38_17.wav",
    }
  },
  {
    id: "",
    text: "The continuous sound of crashing waves, accompanied by the surging tide, comes from in front.",
    foa: {
      gt: "./assets/t2sa/yhFN_xVmNsI_90/yhFN_xVmNsI_90_gt.wav",
      mmaudio_as: "./assets/t2sa/yhFN_xVmNsI_90/yhFN_xVmNsI_90_mm.wav",
      omniaudio_text: "./assets/t2sa/yhFN_xVmNsI_90/yhFN_xVmNsI_90_omni.wav",
      s3audio: "./assets/t2sa/yhFN_xVmNsI_90/yhFN_xVmNsI_90.wav",
    }
  },
];

let ACTIVE_CELL = null;
let AUDIO_CTX = null;
let FOA_RENDERER = null;

/* ====== Audio (extended minimally for T2SA playback) ====== */
let ACTIVE_AUDIO_SRC = null;

async function ensureAudio(){
  if (!AUDIO_CTX) AUDIO_CTX = new (window.AudioContext || window.webkitAudioContext)();

  // Omnitone 可能没加载成功（路径错），这里做个保护
  if (!FOA_RENDERER) {
    if (!window.Omnitone) {
      throw new Error("Omnitone is not loaded. Check ./assets/lib/omnitone.min.js");
    }
    FOA_RENDERER = Omnitone.createFOARenderer(AUDIO_CTX);
    await FOA_RENDERER.initialize();
    FOA_RENDERER.output.connect(AUDIO_CTX.destination);
  }

  if (AUDIO_CTX.state !== "running") await AUDIO_CTX.resume();
}

function stopFOA(){
  if (ACTIVE_AUDIO_SRC) {
    try { ACTIVE_AUDIO_SRC.stop(); } catch {}
    try { ACTIVE_AUDIO_SRC.disconnect(); } catch {}
    ACTIVE_AUDIO_SRC = null;
  }
}

async function playFOA(url){
  await ensureAudio();
  stopFOA();

  const resp = await fetch(url);
  const buf = await resp.arrayBuffer();
  const audioBuffer = await AUDIO_CTX.decodeAudioData(buf);

  const src = AUDIO_CTX.createBufferSource();
  src.buffer = audioBuffer;
  src.connect(FOA_RENDERER.input);
  src.start();

  ACTIVE_AUDIO_SRC = src;
}

/* ========= Pagination (V2SA) ========= */
const PAGE_SIZE = 1;   // 每页 demo 数量：1 最稳；你可以改成 2
let currentPage = 0;

/* ========= Pagination (T2SA) ========= */
const T2SA_PAGE_SIZE = 1; // 每页 demo 数量：默认 1
let t2saPage = 0;

function stopAll(){
  // 停视频
  document.querySelectorAll("#v2saRows video").forEach(v => {
    try { v.pause(); } catch {}
  });

  // 强制释放 WebGL：销毁 a-scene 的 renderer/context
  document.querySelectorAll("#v2saRows a-scene").forEach(scene => {
    try {
      if (scene.renderer?.dispose) scene.renderer.dispose();
      if (scene.renderer?.forceContextLoss) scene.renderer.forceContextLoss();
    } catch {}
  });

  stopFOA();
  ACTIVE_CELL = null;
}

function makeCell(demo, key, label){
  const cell = document.createElement("div");
  cell.className = "cell";

  const viewer = document.createElement("div");
  viewer.className = "viewer";

  const vidId = `${demo.id}-${key}-vid`;
  const camId = `${demo.id}-${key}-cam`;

  viewer.innerHTML = `
    <a-scene embedded vr-mode-ui="enabled:false">
      <a-assets>
        <video id="${vidId}" src="${demo.video360}" crossorigin="anonymous" playsinline webkit-playsinline></video>
      </a-assets>
      <a-entity id="${camId}" camera look-controls position="0 1.6 0"></a-entity>
      <a-videosphere src="#${vidId}" rotation="0 -90 0"></a-videosphere>
    </a-scene>
  `;

  const controls = document.createElement("div");
  controls.className = "controls";

  const playBtn = document.createElement("button");
  playBtn.textContent = "Play";

  const stopBtn = document.createElement("button");
  stopBtn.textContent = "Stop";

  const status = document.createElement("div");
  status.className = "status";
  // status.textContent = label;
  status.style.display = "none";

  controls.appendChild(playBtn);
  controls.appendChild(stopBtn);
  controls.appendChild(status);

  cell.appendChild(viewer);
  cell.appendChild(controls);

  playBtn.addEventListener("click", async () => {
    if (ACTIVE_CELL) ACTIVE_CELL.stop();

    ACTIVE_CELL = {
      stop: () => {
        const v = document.getElementById(vidId);
        if (v) {
          try { v.pause(); } catch {}
          try { v.currentTime = 0; } catch {}
        }
      }
    };

    try {
      await ensureAudio();

      const videoEl = document.getElementById(vidId);
      videoEl.muted = true; // 视频静音，音频走 Omnitone
      await videoEl.play();

      // 这里你原本没接 FOA 播放逻辑（只是初始化 Omnitone）
      // 如果你后续要接入 FOA 播放，我们再加。
      status.textContent = `${label} (playing)`;
    } catch (e) {
      console.error(e);
      status.textContent = `${label} (failed)`;
    }
  });

  stopBtn.addEventListener("click", () => {
    const videoEl = document.getElementById(vidId);
    if (videoEl) {
      try { videoEl.pause(); } catch {}
    }
    status.textContent = `${label} (stopped)`;
  });

  return cell;
}

function buildRow(demo){
  const row = document.createElement("div");
  row.className = "row";
  row.appendChild(makeCell(demo, "gt", "Ground Truth"));
  row.appendChild(makeCell(demo, "visage", "ViSAGe"));
  row.appendChild(makeCell(demo, "omniaudio", "OmniAudio"));
  row.appendChild(makeCell(demo, "s3audio", "S3Audio"));
  return row;
}

/* ========= Pager UI (V2SA) ========= */
function insertPager(){
  // const sections = Array.from(document.querySelectorAll("section.section.center"));
  // const target = sections.find(sec => (sec.querySelector("h2")?.textContent || "").trim() === "Comparisons with Baselines");
  const target = document.getElementById("v2saSection");
  if (!target) return;

  if (target.querySelector(".pager")) return;

  const pager = document.createElement("div");
  pager.className = "pager";
  pager.style.display = "flex";
  pager.style.justifyContent = "center";
  pager.style.alignItems = "center";
  pager.style.gap = "16px";
  pager.style.margin = "10px auto 14px";

  pager.innerHTML = `
    <button class="pager-btn pill" id="pagerPrev">Prev</button>
    <button class="pager-btn pill" id="pagerNext">Next</button>
  `;

  const h2 = target.querySelector("h2");
  h2.insertAdjacentElement("afterend", pager);

  const prev = document.getElementById("pagerPrev");
  const next = document.getElementById("pagerNext");

  prev.addEventListener("click", () => {
    currentPage = (currentPage - 1 + V2SA_DEMOS.length) % V2SA_DEMOS.length;
    renderPage();
  });

  next.addEventListener("click", () => {
    currentPage = (currentPage + 1) % V2SA_DEMOS.length;
    renderPage();
  });
}

function renderPage(){
  stopAll();

  const root = document.getElementById("v2saRows");
  if (!root) return;

  // 清空旧 DOM（真正销毁 scene，释放 WebGL）
  root.innerHTML = "";

  const start = currentPage * PAGE_SIZE;
  const end = Math.min(start + PAGE_SIZE, V2SA_DEMOS.length);

  for (let i = start; i < end; i++) {
    root.appendChild(buildRow(V2SA_DEMOS[i]));
  }
}

/* ====== T2SA (NEW) ====== */
function makeTextCell(demo){
  const cell = document.createElement("div");
  cell.className = "cell text-cell";

  const box = document.createElement("div");
  box.className = "text-box";
  box.innerHTML = `
    <div class="text-id">${demo.id}</div>
    <div>${escapeHtml(demo.text || "")}</div>
  `;

  cell.appendChild(box);
  return cell;
}

function makeAudioOnlyCell(demo, key, label){
  const cell = document.createElement("div");
  cell.className = "cell";

  const viewer = document.createElement("div");
  viewer.className = "viewer";
  viewer.innerHTML = `<div class="placeholder">Audio only</div>`;

  const controls = document.createElement("div");
  controls.className = "controls";

  const playBtn = document.createElement("button");
  playBtn.textContent = "Play";

  const stopBtn = document.createElement("button");
  stopBtn.textContent = "Stop";

  const status = document.createElement("div");
  status.className = "status";
  // status.textContent = label;
  status.style.display = "none";

  controls.appendChild(playBtn);
  controls.appendChild(stopBtn);
  controls.appendChild(status);

  cell.appendChild(viewer);
  cell.appendChild(controls);

  playBtn.addEventListener("click", async () => {
    try {
      await playFOA(demo.foa[key]);
      status.textContent = `${label} (playing)`;
    } catch (e) {
      console.error(e);
      status.textContent = `${label} (failed)`;
    }
  });

  stopBtn.addEventListener("click", () => {
    stopFOA();
    status.textContent = `${label} (stopped)`;
  });

  return cell;
}

function buildT2SARow(demo){
  const row = document.createElement("div");
  row.className = "row cols-5";

  row.appendChild(makeTextCell(demo));
  row.appendChild(makeAudioOnlyCell(demo, "gt", "Ground Truth"));
  row.appendChild(makeAudioOnlyCell(demo, "mmaudio_as", "MMAudio+AS"));
  row.appendChild(makeAudioOnlyCell(demo, "omniaudio_text", "OmniAudio (text)"));
  row.appendChild(makeAudioOnlyCell(demo, "s3audio", "S3Audio"));

  return row;
}

/* ========= Pager UI (T2SA) ========= */
function insertT2SAPager(){
  // const sections = Array.from(document.querySelectorAll("section.section.center"));
  // const target = sections.find(sec => (sec.querySelector("h2")?.textContent || "").trim() === "Text-to-Spatial Audio");
  const target = document.getElementById("t2saSection");
  if (!target) return;

  if (target.querySelector(".pager-t2sa")) return;

  const pager = document.createElement("div");
  pager.className = "pager pager-t2sa";
  pager.style.display = "flex";
  pager.style.justifyContent = "center";
  pager.style.alignItems = "center";
  pager.style.gap = "16px";
  pager.style.margin = "10px auto 14px";

  pager.innerHTML = `
    <button class="pager-btn pill" id="t2saPrev">Prev</button>
    <button class="pager-btn pill" id="t2saNext">Next</button>
  `;

  const h2 = target.querySelector("h2");
  h2.insertAdjacentElement("afterend", pager);

  const prev = document.getElementById("t2saPrev");
  const next = document.getElementById("t2saNext");

  prev.addEventListener("click", () => {
    if (!T2SA_DEMOS.length) return;
    t2saPage = (t2saPage - 1 + T2SA_DEMOS.length) % T2SA_DEMOS.length;
    renderT2SA();
  });

  next.addEventListener("click", () => {
    if (!T2SA_DEMOS.length) return;
    t2saPage = (t2saPage + 1) % T2SA_DEMOS.length;
    renderT2SA();
  });
}

function renderT2SA(){
  stopFOA();

  const root = document.getElementById("t2saRows");
  if (!root) return;

  root.innerHTML = "";

  if (!T2SA_DEMOS.length) return;

  const start = t2saPage * T2SA_PAGE_SIZE;
  const end = Math.min(start + T2SA_PAGE_SIZE, T2SA_DEMOS.length);

  for (let i = start; i < end; i++) {
    root.appendChild(buildT2SARow(T2SA_DEMOS[i]));
  }
}

/* ========= Utils ========= */
function escapeHtml(s){
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function init(){
  insertPager();
  renderPage();

  insertT2SAPager();
  renderT2SA();
}

document.addEventListener("DOMContentLoaded", init);